name: Weekly Amplify Redeploy

on:
  # Run every Sunday at 2 AM UTC
  schedule:
    - cron: "0 2 * * 0"
  # Allow manual triggering from GitHub UI
  workflow_dispatch:

jobs:
  redeploy:
    name: Trigger Amplify Redeploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (for context)
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install AWS CLI (if not preinstalled)
        run: |
          if ! command -v aws &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y awscli
          fi

      - name: Trigger Amplify redeploy
        id: redeploy
        run: |
          echo "Starting scheduled redeploy for Amplify app..."
          for i in {1..3}; do
            if aws amplify start-job \
              --app-id ${{ secrets.AMPLIFY_APP_ID }} \
              --branch-name ${{ secrets.AMPLIFY_BRANCH }} \
              --job-type RELEASE \
              --job-reason "Scheduled weekly redeploy (run $i)" \
              --region ${{ secrets.AWS_REGION }}; then
              echo "✅ Amplify job triggered successfully."
              exit 0
            else
              echo "⚠️ Attempt $i failed. Retrying in 10 seconds..."
              sleep 10
            fi
          done
          echo "❌ All attempts failed to trigger Amplify redeploy."
          exit 1

      - name: Confirm completion
        if: ${{ success() }}
        run: echo "✅ Weekly Amplify redeploy triggered successfully at $(date -u)."
